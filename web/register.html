<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar Akun - GluPulse App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-lg bg-white p-8 rounded-xl shadow-2xl border border-gray-100">
        <h1 class="text-3xl font-bold text-gray-800 text-center mb-6">Buat Akun Baru</h1>
        <p class="text-center text-gray-500 mb-8">Masukkan detail Anda di bawah ini untuk mendaftar.</p>
        
        <form id="registerForm" class="space-y-6">

            <!-- Authentication Fields -->
            <div class="space-y-4 border-b border-gray-200 pb-6">
                <h2 class="text-xl font-semibold text-gray-800">Detail Akun</h2>
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input type="text" id="username" name="username" placeholder="Pilih Username Unik" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 shadow-sm">
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="email" name="email" placeholder="contoh@mail.com" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 shadow-sm">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="password" name="password" placeholder="Minimal 8 Karakter" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 shadow-sm">
                </div>
            </div>

            <!-- Personal Fields -->
            <div class="space-y-4 border-b border-gray-200 pb-6">
                <h2 class="text-xl font-semibold text-gray-800">Detail Pribadi</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="first_name" class="block text-sm font-medium text-gray-700 mb-1">Nama Depan</label>
                        <input type="text" id="first_name" name="first_name" placeholder="John" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 shadow-sm">
                    </div>
                    <div>
                        <label for="last_name" class="block text-sm font-medium text-gray-700 mb-1">Nama Belakang</label>
                        <input type="text" id="last_name" name="last_name" placeholder="Doe" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 shadow-sm">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="dob" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Lahir (DOB)</label>
                        <input type="date" id="dob" name="dob" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 shadow-sm">
                    </div>
                    <div>
                        <label for="gender" class="block text-sm font-medium text-gray-700 mb-1">Gender</label>
                        <select id="gender" name="gender" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 shadow-sm">
                            <option value="" disabled selected>Pilih Gender</option>
                            <option value="Male">Laki-laki</option>
                            <option value="Female">Perempuan</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Address Fields (Optional) -->
            <div class="space-y-4">
                <h2 class="text-xl font-semibold text-gray-800">Detail Alamat (Opsional)</h2>
                <div>
                    <label for="address_label" class="block text-sm font-medium text-gray-700 mb-1">Label Alamat</label>
                    <input type="text" id="address_label" name="address_label" placeholder="Contoh: Rumah / Kantor"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 shadow-sm">
                </div>
                <div>
                    <label for="address_line1" class="block text-sm font-medium text-gray-700 mb-1">Alamat Baris 1</label>
                    <input type="text" id="address_line1" name="address_line1" placeholder="Nama Jalan, Nomor Rumah"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 shadow-sm">
                </div>
                <div>
                    <label for="address_line2" class="block text-sm font-medium text-gray-700 mb-1">Alamat Baris 2 (Opsional)</label>
                    <input type="text" id="address_line2" name="address_line2" placeholder="Detail Tambahan, Contoh: Blok 1"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 shadow-sm">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="city" class="block text-sm font-medium text-gray-700 mb-1">Kota</label>
                        <input type="text" id="city" name="city" placeholder="Jakarta"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 shadow-sm">
                    </div>
                    <div>
                        <label for="province" class="block text-sm font-medium text-gray-700 mb-1">Provinsi</label>
                        <input type="text" id="province" name="province" placeholder="DKI Jakarta"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 shadow-sm">
                    </div>
                    <div>
                        <label for="postal_code" class="block text-sm font-medium text-gray-700 mb-1">Kode Pos</label>
                        <input type="text" id="postal_code" name="postal_code" placeholder="12345"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 shadow-sm">
                    </div>
                </div>
            </div>

            <!-- Register Button -->
            <button type="submit" id="registerButton"
                    class="w-full bg-green-600 text-white font-semibold py-2.5 rounded-lg hover:bg-green-700 transition duration-300 shadow-lg shadow-green-200/50">
                Daftar Akun
            </button>

            <!-- Status/Message Box (DIPINDAHKAN DI SINI) -->
            <div id="messageBox" class="p-3 rounded-lg text-sm text-center hidden" role="alert"></div>

        </form>

        <!-- Login Link -->
        <p class="text-center text-sm text-gray-500 mt-8">
            Sudah punya akun?
            <a href="/login" class="font-semibold text-sky-600 hover:text-sky-800 transition duration-150">
                Kembali ke Login
            </a>
        </p>
    </div>

    <script>
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const button = document.getElementById('registerButton');
            button.disabled = true;
            button.textContent = 'Memproses...';
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());

            // Prepare address data (latitude and longitude are placeholders for now)
            data.latitude = 0;
            data.longitude = 0;
            
            showMessage('Mencoba mendaftar...', 'bg-blue-100 text-blue-800');

            try {
                const response = await fetch('/signup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const responseData = await response.json();
                
                if (response.ok) {
                    // Success: Store tokens and redirect (optional: store tokens)
                    
                    // Note: Registration flow typically redirects to login, 
                    // or directly logs in and sets cookies/tokens. 
                    // For this flow, we assume the backend returns auth tokens, 
                    // but we will primarily redirect to login as per standard practice.
                    
                    // Store tokens (if API returns them)
                    if (responseData.access_token && responseData.refresh_token) {
                        document.cookie = `access-token=${responseData.access_token}; path=/; max-age=${responseData.expires_in}; Secure; SameSite=Lax`;
                        document.cookie = `refresh-token=${responseData.refresh_token}; path=/; max-age=${30 * 24 * 60 * 60}; Secure; SameSite=Lax`;
                    }


                    showMessage('Pendaftaran Berhasil! Mengalihkan ke halaman Login.', 'bg-green-100 text-green-800');
                    setTimeout(() => {
                        window.location.href = '/login'; 
                    }, 1500);

                } else {
                    // Failure: Display specific error message
                    const errorMessage = responseData.error || 'Terjadi kesalahan pada server.';
                    showMessage(`Pendaftaran Gagal: ${errorMessage}`, 'bg-red-100 text-red-800');
                }

            } catch (error) {
                console.error('Network or unexpected error:', error);
                showMessage('Kesalahan Jaringan. Tidak dapat terhubung ke server.', 'bg-red-100 text-red-800');
            } finally {
                button.disabled = false;
                button.textContent = 'Daftar Akun';
            }
        });

        function showMessage(message, classes) {
            const box = document.getElementById('messageBox');
            box.textContent = message;
            // Clear previous classes and apply new ones
            box.className = 'p-3 rounded-lg text-sm text-center ' + classes;
            box.style.display = 'block';
        }

        // Fix the href for the login link
        document.querySelector('a[href="login.html"]').setAttribute('href', '/login');
    </script>
</body>
</html>
