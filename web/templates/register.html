<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - Glupulse Seller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        brand: {
                            50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 900: '#0c4a6e',
                        }
                    },
                    animation: {
                        'slide-in': 'slideIn 0.3s ease-out forwards',
                    },
                    keyframes: {
                        slideIn: {
                            '0%': { transform: 'translateX(10px)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .floating-input:focus ~ label, .floating-input:not(:placeholder-shown) ~ label {
            transform: translateY(-1.5rem) scale(0.85); color: #0284c7;
        }
        body::-webkit-scrollbar { display: none; }
        .step-content { display: none; }
        .step-content.active { display: block; animation: slideIn 0.3s ease-out; }
        
        .tab-btn { transition: all 0.3s; cursor: pointer; }
        .tab-btn:hover { color: #0284c7; }
        .tab-btn.active { color: #0284c7; font-weight: 800; border-bottom: 2px solid #0284c7; }
        
        .custom-check:checked + div { border-color: #0ea5e9; background-color: #f0f9ff; color: #0284c7; }

        /* Map Size */
        #map { height: 300px; width: 100%; border-radius: 0.75rem; z-index: 1; }
    </style>
</head>
<body class="bg-brand-50 min-h-screen flex items-center justify-center p-0 md:p-6">

    <div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-3 pointer-events-none"></div>

    <div class="w-full max-w-[1200px] bg-white rounded-none md:rounded-3xl shadow-2xl overflow-hidden flex flex-col md:flex-row min-h-[600px]">
        
        <div class="hidden md:flex w-5/12 bg-gradient-to-br from-brand-900 to-brand-600 relative flex-col p-12 text-white self-stretch">
            <div class="absolute top-10 left-12 z-20">
                <h1 class="text-3xl font-extrabold tracking-tight">Glupulse <span class="text-brand-100 font-light">Seller</span></h1>
            </div>
            
            <div class="flex-1 flex flex-col justify-center z-10 relative mt-8">
                <img src="https://images.unsplash.com/photo-1498837167922-ddd27525d352?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80" 
                     class="w-full rounded-2xl shadow-2xl border-4 border-white/10 mb-8 transform hover:scale-105 transition duration-500 object-cover h-64" alt="Healthy Food Kitchen">
                
                <h2 class="text-2xl font-bold mb-3">Partner Bisnis Makanan Sehat</h2>
                <p class="text-brand-100 opacity-90 leading-relaxed">
                    Kelola menu, terima pesanan, dan bantu pelanggan diabetes hidup lebih sehat dengan platform khusus seller.
                </p>
            </div>
            
            <div class="absolute top-0 right-0 w-64 h-64 bg-white opacity-5 rounded-bl-full pointer-events-none"></div>
            <div class="absolute bottom-0 left-0 w-40 h-40 bg-brand-500 opacity-20 rounded-tr-full pointer-events-none"></div>
        </div>

        <div class="w-full md:w-7/12 p-8 md:p-12 flex flex-col relative bg-white h-auto">
            
            <div class="mb-8 sticky top-0 bg-white z-20 pt-2">
                <div class="flex justify-between text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">
                    <button type="button" onclick="goToStep(1)" id="tab-1" class="tab-btn active text-brand-600 pb-1 focus:outline-none">1. Akun</button>
                    <button type="button" onclick="goToStep(2)" id="tab-2" class="tab-btn pb-1 focus:outline-none">2. Toko</button>
                    <button type="button" onclick="goToStep(3)" id="tab-3" class="tab-btn pb-1 focus:outline-none">3. Lokasi</button>
                </div>
                <div class="w-full bg-gray-100 h-1 rounded-full relative">
                    <div id="progress-bar" class="bg-brand-600 h-1 rounded-full transition-all duration-500 absolute top-0 left-0" style="width: 33%"></div>
                </div>
            </div>

            <h2 class="text-2xl font-bold text-gray-800 mb-2" id="step-title">Informasi Akun</h2>
            <p class="text-gray-500 text-sm mb-6">Lengkapi data untuk mendaftarkan bisnis Anda.</p>

            <form id="registerForm" class="flex-grow flex flex-col" novalidate>
                
                <div id="step-1" class="step-content active space-y-5">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="relative group">
                            <input type="text" id="first_name" name="first_name" placeholder=" " required
                                   class="floating-input peer w-full px-4 py-3.5 border-2 border-gray-200 rounded-xl outline-none focus:border-brand-500 bg-transparent">
                            <label class="absolute left-4 top-3.5 text-gray-400 text-sm transition-all pointer-events-none bg-white px-1">
                                Nama Depan <span class="text-red-500">*</span>
                            </label>
                        </div>
                        <div class="relative group">
                            <input type="text" id="last_name" name="last_name" placeholder=" "
                                   class="floating-input peer w-full px-4 py-3.5 border-2 border-gray-200 rounded-xl outline-none focus:border-brand-500 bg-transparent">
                            <label class="absolute left-4 top-3.5 text-gray-400 text-sm transition-all pointer-events-none bg-white px-1">
                                Nama Belakang
                            </label>
                        </div>
                    </div>

                    <div class="relative group">
                        <input type="text" id="username" name="username" placeholder=" " required
                               class="floating-input peer w-full px-4 py-3.5 border-2 border-gray-200 rounded-xl outline-none focus:border-brand-500 bg-transparent font-medium">
                        <label class="absolute left-4 top-3.5 text-gray-400 text-sm transition-all pointer-events-none bg-white px-1">
                            Username <span class="text-red-500">*</span>
                        </label>
                    </div>

                    <div class="relative group">
                        <input type="email" id="email" name="email" placeholder=" " required
                               class="floating-input peer w-full px-4 py-3.5 border-2 border-gray-200 rounded-xl outline-none focus:border-brand-500 bg-transparent font-medium">
                        <label class="absolute left-4 top-3.5 text-gray-400 text-sm transition-all pointer-events-none bg-white px-1">
                            Email Login <span class="text-red-500">*</span>
                        </label>
                    </div>

                    <div class="relative group">
                        <input type="password" id="password" name="password" placeholder=" " required
                               class="floating-input peer w-full px-4 py-3.5 pr-12 border-2 border-gray-200 rounded-xl outline-none focus:border-brand-500 bg-transparent font-medium">
                        <label class="absolute left-4 top-3.5 text-gray-400 text-sm transition-all pointer-events-none bg-white px-1">
                            Password <span class="text-red-500">*</span>
                        </label>
                        <button type="button" onclick="togglePassword()" class="absolute right-4 top-3.5 text-gray-400 hover:text-brand-600 focus:outline-none cursor-pointer">
                            <i id="eye-icon" class="fas fa-eye"></i>
                        </button>
                        
                        <div class="flex gap-1 mt-2 h-1 opacity-0 peer-focus:opacity-100 transition-opacity">
                            <div id="strength-1" class="flex-1 bg-gray-200 rounded"></div>
                            <div id="strength-2" class="flex-1 bg-gray-200 rounded"></div>
                            <div id="strength-3" class="flex-1 bg-gray-200 rounded"></div>
                            <div id="strength-4" class="flex-1 bg-gray-200 rounded"></div>
                        </div>

                        <p class="text-xs text-gray-500 mt-2 flex flex-col gap-1">
                            <span class="font-semibold">Syarat Password:</span>
                            <span id="req-len" class="flex items-center gap-1 text-gray-400"><i class="fas fa-circle text-[6px]"></i> Minimal 8 Karakter</span>
                            <span id="req-num" class="flex items-center gap-1 text-gray-400"><i class="fas fa-circle text-[6px]"></i> Mengandung Angka</span>
                            <span id="req-cap" class="flex items-center gap-1 text-gray-400"><i class="fas fa-circle text-[6px]"></i> Huruf Besar</span>
                        </p>
                    </div>
                </div>

                <div id="step-2" class="step-content space-y-5">
                    <div class="relative group">
                        <input type="text" id="store_name" name="store_name" placeholder=" " required
                               class="floating-input peer w-full px-4 py-3.5 border-2 border-gray-200 rounded-xl outline-none focus:border-brand-500 bg-transparent">
                        <label class="absolute left-4 top-3.5 text-gray-400 text-sm transition-all pointer-events-none bg-white px-1">
                            Nama Toko / Restoran <span class="text-red-500">*</span>
                        </label>
                    </div>

                    <div class="relative group">
                        <input type="tel" id="store_phone_number" name="store_phone_number" placeholder=" " required
                               class="floating-input peer w-full px-4 py-3.5 border-2 border-gray-200 rounded-xl outline-none focus:border-brand-500 bg-transparent">
                        <label class="absolute left-4 top-3.5 text-gray-400 text-sm transition-all pointer-events-none bg-white px-1">
                            Nomor Telepon Toko <span class="text-red-500">*</span>
                        </label>
                    </div>

                    <div class="relative group">
                        <textarea id="store_description" name="store_description" rows="2" placeholder=" "
                               class="floating-input peer w-full px-4 py-3.5 border-2 border-gray-200 rounded-xl outline-none focus:border-brand-500 bg-transparent"></textarea>
                        <label class="absolute left-4 top-3.5 text-gray-400 text-sm transition-all pointer-events-none bg-white px-1">
                            Deskripsi Singkat Toko
                        </label>
                    </div>

                    <div>
                        <span class="text-xs font-bold text-gray-500 uppercase tracking-wide">Rentang Harga</span>
                        <div class="flex gap-2 mt-2">
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="price_range" value="1" class="custom-check hidden" required>
                                <div class="border-2 border-gray-200 rounded-lg py-2 text-center text-gray-400 hover:border-brand-300 font-bold">$</div>
                            </label>
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="price_range" value="2" class="custom-check hidden">
                                <div class="border-2 border-gray-200 rounded-lg py-2 text-center text-gray-400 hover:border-brand-300 font-bold">$$</div>
                            </label>
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="price_range" value="3" class="custom-check hidden">
                                <div class="border-2 border-gray-200 rounded-lg py-2 text-center text-gray-400 hover:border-brand-300 font-bold">$$$</div>
                            </label>
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="price_range" value="4" class="custom-check hidden">
                                <div class="border-2 border-gray-200 rounded-lg py-2 text-center text-gray-400 hover:border-brand-300 font-bold">$$$$</div>
                            </label>
                        </div>
                    </div>

                    <div>
                        <span class="text-xs font-bold text-gray-500 uppercase tracking-wide">Jenis Kuliner (Pilih Minimal 1)</span>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mt-2" id="cuisine-container">
                            <label class="cursor-pointer"><input type="checkbox" name="cuisine_type" value="Healthy" class="custom-check hidden"><div class="border-2 border-gray-200 rounded-lg px-3 py-1.5 text-sm text-center text-gray-500 font-medium">Healthy</div></label>
                            <label class="cursor-pointer"><input type="checkbox" name="cuisine_type" value="Indonesian" class="custom-check hidden"><div class="border-2 border-gray-200 rounded-lg px-3 py-1.5 text-sm text-center text-gray-500 font-medium">Indonesian</div></label>
                            <label class="cursor-pointer"><input type="checkbox" name="cuisine_type" value="Western" class="custom-check hidden"><div class="border-2 border-gray-200 rounded-lg px-3 py-1.5 text-sm text-center text-gray-500 font-medium">Western</div></label>
                            <label class="cursor-pointer"><input type="checkbox" name="cuisine_type" value="Asian" class="custom-check hidden"><div class="border-2 border-gray-200 rounded-lg px-3 py-1.5 text-sm text-center text-gray-500 font-medium">Asian</div></label>
                            <label class="cursor-pointer"><input type="checkbox" name="cuisine_type" value="Beverages" class="custom-check hidden"><div class="border-2 border-gray-200 rounded-lg px-3 py-1.5 text-sm text-center text-gray-500 font-medium">Beverages</div></label>
                            <label class="cursor-pointer"><input type="checkbox" name="cuisine_type" value="Salad" class="custom-check hidden"><div class="border-2 border-gray-200 rounded-lg px-3 py-1.5 text-sm text-center text-gray-500 font-medium">Salad</div></label>
                            <label class="cursor-pointer col-span-2 md:col-span-1">
                                <input type="checkbox" id="cuisine_other_check" onchange="toggleOtherCuisine()" class="custom-check hidden">
                                <div class="border-2 border-gray-200 rounded-lg px-3 py-1.5 text-sm text-center text-gray-500 font-medium">Lainnya...</div>
                            </label>
                        </div>
                        <div id="other_cuisine_container" class="mt-2 hidden">
                            <input type="text" id="other_cuisine_input" placeholder="Sebutkan (pisahkan dengan koma)" 
                                   class="w-full px-4 py-2 text-sm border-2 border-brand-200 rounded-lg focus:outline-none focus:border-brand-500">
                        </div>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                        <span class="text-xs font-bold text-gray-500 uppercase tracking-wide block mb-3">Jam Operasional (Per Hari)</span>
                        <div id="business-hours-container" class="space-y-3"></div>
                    </div>
                </div>

                <div id="step-3" class="step-content space-y-5">
                    
                    <div class="relative group">
                        <input type="text" id="address_line1" name="address_line1" placeholder=" " required
                               class="floating-input peer w-full px-4 py-3.5 border-2 border-gray-200 rounded-xl outline-none focus:border-brand-500 bg-transparent">
                        <label class="absolute left-4 top-3.5 text-gray-400 text-sm transition-all pointer-events-none bg-white px-1">
                            Alamat Jalan <span class="text-red-500">*</span>
                        </label>
                    </div>
                    
                    <div class="relative group">
                        <input type="text" id="address_line2" name="address_line2" placeholder=" "
                               class="floating-input peer w-full px-4 py-3.5 border-2 border-gray-200 rounded-xl outline-none focus:border-brand-500 bg-transparent">
                        <label class="absolute left-4 top-3.5 text-gray-400 text-sm transition-all pointer-events-none bg-white px-1">
                            Detail (Lt, Unit, Patokan)
                        </label>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="relative group">
                            <input type="text" id="district" name="district" placeholder=" " required
                                   class="floating-input peer w-full px-4 py-3.5 border-2 border-gray-200 rounded-xl outline-none focus:border-brand-500 bg-transparent">
                            <label class="absolute left-4 top-3.5 text-gray-400 text-sm transition-all pointer-events-none bg-white px-1">
                                Kecamatan <span class="text-red-500">*</span>
                            </label>
                        </div>
                        <div class="relative group">
                            <input type="text" id="city" name="city" placeholder=" " required
                                   class="floating-input peer w-full px-4 py-3.5 border-2 border-gray-200 rounded-xl outline-none focus:border-brand-500 bg-transparent">
                            <label class="absolute left-4 top-3.5 text-gray-400 text-sm transition-all pointer-events-none bg-white px-1">
                                Kota/Kab <span class="text-red-500">*</span>
                            </label>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="relative group">
                            <input type="text" id="province" name="province" placeholder=" " required
                                   class="floating-input peer w-full px-4 py-3.5 border-2 border-gray-200 rounded-xl outline-none focus:border-brand-500 bg-transparent">
                            <label class="absolute left-4 top-3.5 text-gray-400 text-sm transition-all pointer-events-none bg-white px-1">
                                Provinsi <span class="text-red-500">*</span>
                            </label>
                        </div>
                        <div class="relative group">
                            <input type="text" id="postal_code" name="postal_code" placeholder=" " required
                                   class="floating-input peer w-full px-4 py-3.5 border-2 border-gray-200 rounded-xl outline-none focus:border-brand-500 bg-transparent">
                            <label class="absolute left-4 top-3.5 text-gray-400 text-sm transition-all pointer-events-none bg-white px-1">
                                Kode Pos <span class="text-red-500">*</span>
                            </label>
                        </div>
                    </div>

                    <div class="p-4 bg-orange-50 border border-orange-100 rounded-xl">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-sm font-bold text-orange-900">Pinpoint Lokasi</h4>
                            <span class="text-xs text-orange-700">Geser pin untuk isi otomatis alamat</span>
                        </div>
                        
                        <div id="map" class="mb-3 border border-orange-200 relative"></div>

                        <input type="hidden" id="latitude">
                        <input type="hidden" id="longitude">
                    </div>
                </div>

                <div class="mt-8 pt-6 flex justify-between items-center border-t border-gray-100">
                    <button type="button" id="prevBtn" onclick="modifyStep(-1)" 
                            class="hidden text-gray-500 font-semibold hover:text-brand-600 px-4 py-2 text-sm transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>Kembali
                    </button>
                    
                    <button type="button" id="nextBtn" onclick="modifyStep(1)"
                            class="bg-brand-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-brand-700 shadow-lg hover:shadow-brand-500/30 transform active:scale-95 transition-all flex items-center gap-2 ml-auto">
                        <span>Lanjut</span>
                        <i class="fas fa-arrow-right"></i>
                    </button>

                    <button type="submit" id="submitBtn"
                            class="hidden bg-green-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-green-700 shadow-lg hover:shadow-green-500/30 transform active:scale-95 transition-all flex items-center gap-2 ml-auto">
                        <span>Daftar Toko</span>
                        <i class="fas fa-check"></i>
                    </button>
                </div>
            </form>

            <p class="text-center text-sm text-gray-500 mt-6 pb-4">
                Sudah punya akun? <a href="/seller/login" class="font-bold text-brand-600 hover:underline">Masuk disini</a>
            </p>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        const API_BASE_URL = window.location.origin;
        const REGISTER_ENDPOINT = '/auth/seller/signup'; 
        const OTP_VERIFY_URL = '/seller/verify-otp';

        let currentStep = 1;
        let map = null;
        let marker = null;

        document.addEventListener('DOMContentLoaded', () => {
            renderBusinessHours();
        });

        // --- PASSWORD LOGIC ---
        function togglePassword() {
            const input = document.getElementById('password');
            const icon = document.getElementById('eye-icon');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash'); icon.classList.add('fa-eye');
            }
        }

        document.getElementById('password').addEventListener('input', function(e) {
            const val = e.target.value;
            const bars = [
                document.getElementById('strength-1'),
                document.getElementById('strength-2'),
                document.getElementById('strength-3'),
                document.getElementById('strength-4')
            ];
            const reqLen = document.getElementById('req-len');
            const reqNum = document.getElementById('req-num');
            const reqCap = document.getElementById('req-cap');

            val.length >= 8 ? reqLen.classList.replace('text-gray-400', 'text-green-500') : reqLen.classList.replace('text-green-500', 'text-gray-400');
            /\d/.test(val) ? reqNum.classList.replace('text-gray-400', 'text-green-500') : reqNum.classList.replace('text-green-500', 'text-gray-400');
            /[A-Z]/.test(val) ? reqCap.classList.replace('text-gray-400', 'text-green-500') : reqCap.classList.replace('text-green-500', 'text-gray-400');

            let score = 0;
            if (val.length > 4) score++;
            if (val.length >= 8) score++;
            if (/\d/.test(val)) score++;
            if (/[A-Z]/.test(val)) score++;

            bars.forEach(b => b.className = 'flex-1 bg-gray-200 rounded transition-colors duration-300');
            if (score > 0) bars[0].className = 'flex-1 bg-red-400 rounded';
            if (score > 1) bars[1].className = 'flex-1 bg-yellow-400 rounded';
            if (score > 2) bars[2].className = 'flex-1 bg-blue-400 rounded';
            if (score > 3) bars[3].className = 'flex-1 bg-green-500 rounded';
        });

        // --- CUISINE LOGIC ---
        function toggleOtherCuisine() {
            const isChecked = document.getElementById('cuisine_other_check').checked;
            const container = document.getElementById('other_cuisine_container');
            if(isChecked) {
                container.classList.remove('hidden');
                document.getElementById('other_cuisine_input').focus();
            } else {
                container.classList.add('hidden');
            }
        }

        // --- BUSINESS HOURS ---
        function renderBusinessHours() {
            const container = document.getElementById('business-hours-container');
            const days = [
                { id: 'monday', label: 'Senin' }, { id: 'tuesday', label: 'Selasa' },
                { id: 'wednesday', label: 'Rabu' }, { id: 'thursday', label: 'Kamis' },
                { id: 'friday', label: 'Jumat' }, { id: 'saturday', label: 'Sabtu' },
                { id: 'sunday', label: 'Minggu' }
            ];

            let html = '';
            days.forEach(day => {
                html += `
                    <div class="flex flex-col sm:flex-row gap-2 sm:items-center border-b border-gray-100 pb-2 last:border-0 last:pb-0">
                        <div class="w-24 flex items-center gap-2">
                            <input type="checkbox" id="closed_${day.id}" onchange="toggleDay('${day.id}')" class="w-4 h-4 text-brand-600 rounded focus:ring-brand-500 border-gray-300">
                            <span class="text-sm font-medium text-gray-700">${day.label}</span>
                        </div>
                        <div class="flex items-center gap-2 flex-1" id="time_inputs_${day.id}">
                            <input type="time" id="open_${day.id}" value="09:00" class="flex-1 p-1.5 text-sm border rounded-lg bg-white text-center">
                            <span class="text-gray-400 text-xs">s/d</span>
                            <input type="time" id="close_${day.id}" value="21:00" class="flex-1 p-1.5 text-sm border rounded-lg bg-white text-center">
                        </div>
                        <div class="hidden text-xs text-red-500 font-bold flex-1" id="closed_label_${day.id}">TUTUP</div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function toggleDay(dayId) {
            const isClosed = document.getElementById(`closed_${dayId}`).checked;
            document.getElementById(`time_inputs_${dayId}`).classList.toggle('hidden', isClosed);
            document.getElementById(`closed_label_${dayId}`).classList.toggle('hidden', !isClosed);
        }

        // --- MAP & AUTOFILL LOGIC ---
        function initMap() {
            if (map !== null) return;
            const defaultLat = -6.2088;
            const defaultLng = 106.8456;
            
            // Set hidden inputs
            document.getElementById('latitude').value = defaultLat;
            document.getElementById('longitude').value = defaultLng;

            map = L.map('map').setView([defaultLat, defaultLng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);

            marker = L.marker([defaultLat, defaultLng], { draggable: true }).addTo(map);

            marker.on('dragend', function (e) {
                const pos = marker.getLatLng();
                updateCoords(pos.lat, pos.lng);
                reverseGeocode(pos.lat, pos.lng);
            });

            map.on('click', function(e) {
                marker.setLatLng(e.latlng);
                updateCoords(e.latlng.lat, e.latlng.lng);
                reverseGeocode(e.latlng.lat, e.latlng.lng);
            });

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    map.setView([lat, lng], 15);
                    marker.setLatLng([lat, lng]);
                    updateCoords(lat, lng);
                    reverseGeocode(lat, lng);
                });
            }
        }

        function updateCoords(lat, lng) {
            document.getElementById('latitude').value = lat.toFixed(7);
            document.getElementById('longitude').value = lng.toFixed(7);
        }

        async function reverseGeocode(lat, lng) {
            try {
                document.body.style.cursor = 'wait';
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                const data = await response.json();
                
                if (data.address) {
                    const addr = data.address;
                    const district = addr.suburb || addr.village || addr.neighbourhood || '';
                    const city = addr.city || addr.town || addr.county || '';
                    const province = addr.state || addr.region || '';
                    const postCode = addr.postcode || '';

                    if(district) document.getElementById('district').value = district;
                    if(city) document.getElementById('city').value = city;
                    if(province) document.getElementById('province').value = province;
                    if(postCode) document.getElementById('postal_code').value = postCode;
                }
            } catch (err) {
                console.error("Autofill failed:", err);
            } finally {
                document.body.style.cursor = 'default';
            }
        }

        // --- NAVIGATION & VALIDATION ---
        function modifyStep(increment) {
            const target = currentStep + increment;
            goToStep(target);
        }

        function goToStep(targetStep) {
            if (targetStep < 1 || targetStep > 3) return;
            if (targetStep > currentStep) {
                if (!validateStep(currentStep)) return;
            }
            currentStep = targetStep;
            updateUI(currentStep);

            if (currentStep === 3) {
                setTimeout(() => {
                    initMap();
                    map.invalidateSize();
                }, 200);
            }
        }

        function updateUI(step) {
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`step-${step}`).classList.add('active');
            
            const percentage = step === 1 ? '33%' : (step === 2 ? '66%' : '100%');
            document.getElementById('progress-bar').style.width = percentage;

            document.querySelectorAll('.tab-btn').forEach((btn, idx) => {
                if (idx + 1 === step) {
                    btn.classList.add('active', 'text-brand-600');
                    btn.classList.remove('text-gray-400');
                } else {
                    btn.classList.remove('active', 'text-brand-600');
                    btn.classList.add('text-gray-400');
                }
            });

            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');
            const title = document.getElementById('step-title');
            
            if (step === 1) {
                title.innerText = "Informasi Akun";
                prevBtn.classList.add('hidden'); nextBtn.classList.remove('hidden'); submitBtn.classList.add('hidden');
            } else if (step === 2) {
                title.innerText = "Profil Toko";
                prevBtn.classList.remove('hidden'); nextBtn.classList.remove('hidden'); submitBtn.classList.add('hidden');
            } else if (step === 3) {
                title.innerText = "Lokasi & Alamat";
                prevBtn.classList.remove('hidden'); nextBtn.classList.add('hidden'); submitBtn.classList.remove('hidden');
            }
        }

        function validateStep(step) {
            let valid = true;
            const container = document.getElementById(`step-${step}`);
            const inputs = container.querySelectorAll('input[required], textarea[required]');
            
            inputs.forEach(input => {
                if (!input.value.trim()) {
                    valid = false;
                    input.classList.add('border-red-500');
                    input.addEventListener('input', () => input.classList.remove('border-red-500'), {once:true});
                }
            });

            if (step === 2) {
                const checkboxes = document.querySelectorAll('input[name="cuisine_type"]:checked');
                const otherCheck = document.getElementById('cuisine_other_check').checked;
                const otherInput = document.getElementById('other_cuisine_input').value.trim();
                const hasOther = otherCheck && otherInput.length > 0;
                
                if (checkboxes.length === 0 && !hasOther) { 
                    valid = false; 
                    showToast('Pilih minimal 1 jenis kuliner'); 
                }
                if (!document.querySelector('input[name="price_range"]:checked')) { 
                    valid = false; 
                    showToast('Pilih rentang harga'); 
                }
            }

            if (!valid) showToast('Mohon lengkapi data yang wajib diisi');
            return valid;
        }

        function showToast(msg) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `bg-white border-l-4 border-red-500 shadow-xl rounded-lg p-4 flex items-center gap-3 transform translate-x-full transition-all duration-300 pointer-events-auto`;
            toast.innerHTML = `<i class="fas fa-exclamation-circle text-red-500 text-xl"></i><span class="text-gray-700 text-sm font-medium">${msg}</span>`;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.remove('translate-x-full'));
            setTimeout(() => { toast.classList.add('translate-x-full'); setTimeout(() => toast.remove(), 300); }, 3000);
        }

        // --- SUBMIT ---
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!validateStep(3)) return;

            const btn = document.getElementById('submitBtn');
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Proses...`;

            let cuisineTypes = Array.from(document.querySelectorAll('input[name="cuisine_type"]:checked')).map(cb => cb.value);
            if (document.getElementById('cuisine_other_check').checked) {
                const otherVal = document.getElementById('other_cuisine_input').value;
                const others = otherVal.split(',').map(s => s.trim()).filter(s => s);
                cuisineTypes = [...cuisineTypes, ...others];
            }

            const days = ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "sunday"];
            const businessHours = {};
            days.forEach(day => {
                const isClosed = document.getElementById(`closed_${day}`).checked;
                businessHours[day] = {
                    open: document.getElementById(`open_${day}`).value,
                    close: document.getElementById(`close_${day}`).value,
                    closed: isClosed
                };
            });

            const payload = {
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                email: document.getElementById('email').value,
                first_name: document.getElementById('first_name').value,
                last_name: document.getElementById('last_name').value,
                store_name: document.getElementById('store_name').value,
                store_phone_number: document.getElementById('store_phone_number').value,
                store_description: document.getElementById('store_description').value,
                price_range: parseInt(document.querySelector('input[name="price_range"]:checked').value),
                cuisine_type: cuisineTypes,
                business_hours: businessHours,
                address_line1: document.getElementById('address_line1').value,
                address_line2: document.getElementById('address_line2').value,
                district: document.getElementById('district').value,
                city: document.getElementById('city').value,
                province: document.getElementById('province').value,
                postal_code: document.getElementById('postal_code').value,
                latitude: parseFloat(document.getElementById('latitude').value),
                longitude: parseFloat(document.getElementById('longitude').value),
                gmaps_link: "" 
            };

            try {
                const response = await fetch(REGISTER_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.status === 202) {
                    localStorage.setItem('pending_id', data.pending_id);
                    localStorage.setItem('email_sent', data.email);
                    window.location.href = OTP_VERIFY_URL;
                } else {
                    throw new Error(data.error || 'Gagal mendaftar');
                }
            } catch (error) {
                showToast(error.message);
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        });
    </script>
</body>
</html>