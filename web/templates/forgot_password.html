<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Glupulse Seller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        brand: {
                            50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 900: '#0c4a6e',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s ease-out forwards',
                        'slide-up': 'slideUp 0.4s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .otp-input:focus { transform: scale(1.05); border-color: #0ea5e9; }
        
        /* Floating Label Fix */
        .floating-input:focus ~ label,
        .floating-input:not(:placeholder-shown) ~ label {
            transform: translateY(-1.5rem) scale(0.85);
            color: #0284c7;
            background-color: white;
            padding: 0 4px;
        }
    </style>
</head>
<body class="bg-brand-50 min-h-screen flex items-center justify-center p-4">

    <div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-3 pointer-events-none"></div>

    <div class="w-full max-w-md bg-white rounded-3xl shadow-xl overflow-hidden relative">
        <div class="bg-gradient-to-r from-brand-600 to-brand-800 h-32 flex items-center justify-center relative overflow-hidden">
            <div class="absolute w-64 h-64 bg-white opacity-10 rounded-full -top-32 -left-10"></div>
            <div class="absolute w-40 h-40 bg-white opacity-10 rounded-full -bottom-20 -right-10"></div>
            <div class="bg-white/20 p-4 rounded-full backdrop-blur-sm z-10">
                <i class="fas fa-lock-open text-3xl text-white"></i>
            </div>
        </div>

        <div class="p-8">
            
            <div id="step-1" class="animate-slide-up">
                <h2 class="text-2xl font-bold text-gray-800 text-center mb-2">Lupa Password?</h2>
                <p class="text-gray-500 text-center text-sm mb-8">Masukkan email yang terdaftar. Kami akan mengirimkan kode verifikasi untuk mereset password Anda.</p>

                <form id="requestForm" class="space-y-6">
                    <div class="relative group">
                        <input type="email" id="email" placeholder=" " required
                               class="floating-input peer w-full px-4 py-3.5 border-2 border-gray-200 rounded-xl outline-none focus:border-brand-500 bg-transparent text-gray-700 transition-colors">
                        <label class="absolute left-4 top-3.5 text-gray-400 text-sm transition-all pointer-events-none bg-white px-1">
                            Email Terdaftar
                        </label>
                    </div>

                    <button type="submit" id="requestBtn"
                            class="w-full bg-brand-600 text-white font-bold py-3.5 rounded-xl hover:bg-brand-700 shadow-lg shadow-brand-500/30 transition-all flex items-center justify-center gap-2">
                        <span>Kirim Kode</span>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>

            <div id="step-2" class="hidden">
                <h2 class="text-2xl font-bold text-gray-800 text-center mb-2">Reset Password</h2>
                <p class="text-gray-500 text-center text-sm mb-6">Kode dikirim ke <span id="display-email" class="font-bold text-brand-600"></span></p>

                <form id="resetForm" class="space-y-6">
                    
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-2 text-center">Masukkan 6 Digit Kode</label>
                        <div class="flex justify-between gap-1 mb-4">
                            <input type="number" class="otp-input w-10 h-12 border-2 border-gray-200 rounded-lg text-center text-xl font-bold outline-none transition-all" maxlength="1">
                            <input type="number" class="otp-input w-10 h-12 border-2 border-gray-200 rounded-lg text-center text-xl font-bold outline-none transition-all" maxlength="1">
                            <input type="number" class="otp-input w-10 h-12 border-2 border-gray-200 rounded-lg text-center text-xl font-bold outline-none transition-all" maxlength="1">
                            <input type="number" class="otp-input w-10 h-12 border-2 border-gray-200 rounded-lg text-center text-xl font-bold outline-none transition-all" maxlength="1">
                            <input type="number" class="otp-input w-10 h-12 border-2 border-gray-200 rounded-lg text-center text-xl font-bold outline-none transition-all" maxlength="1">
                            <input type="number" class="otp-input w-10 h-12 border-2 border-gray-200 rounded-lg text-center text-xl font-bold outline-none transition-all" maxlength="1">
                        </div>
                    </div>

                    <div class="relative">
                        <input type="password" id="new_password" placeholder="Password Baru" required
                               class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl outline-none focus:border-brand-500 text-sm">
                        <i class="fas fa-eye absolute right-4 top-3.5 text-gray-400 cursor-pointer hover:text-brand-600" onclick="togglePass('new_password', this)"></i>
                    </div>

                    <div class="relative">
                        <input type="password" id="confirm_password" placeholder="Konfirmasi Password" required
                               class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl outline-none focus:border-brand-500 text-sm">
                        <i class="fas fa-eye absolute right-4 top-3.5 text-gray-400 cursor-pointer hover:text-brand-600" onclick="togglePass('confirm_password', this)"></i>
                    </div>

                    <button type="submit" id="resetBtn"
                            class="w-full bg-brand-600 text-white font-bold py-3.5 rounded-xl hover:bg-brand-700 shadow-lg shadow-brand-500/30 transition-all">
                        Ubah Password
                    </button>
                </form>
            </div>

            <div id="success-state" class="hidden text-center py-4">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce">
                    <i class="fas fa-check text-2xl text-green-600"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Berhasil!</h3>
                <p class="text-gray-500 text-sm mb-6">Password Anda telah diperbarui. Silakan login dengan password baru.</p>
                <a href="/seller/login" class="block w-full bg-gray-800 text-white font-bold py-3 rounded-xl hover:bg-gray-900 transition-all">
                    Masuk Sekarang
                </a>
            </div>

            <div id="footer-link" class="mt-8 text-center border-t border-gray-100 pt-4">
                <a href="/seller/login" class="text-sm font-bold text-gray-400 hover:text-brand-600 transition-colors">
                    <i class="fas fa-arrow-left mr-1"></i> Kembali ke Login
                </a>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.location.origin;
        
        let retrievedUserId = null;

        // --- UTILS ---
        function showToast(msg, type = 'error') {
            const container = document.getElementById('toast-container');
            const div = document.createElement('div');
            const color = type === 'success' ? 'border-green-500' : 'border-red-500';
            const icon = type === 'success' ? 'fa-check-circle text-green-500' : 'fa-exclamation-circle text-red-500';
            div.className = `bg-white border-l-4 ${color} shadow-lg rounded-lg p-4 flex gap-3 min-w-[300px] pointer-events-auto transform translate-x-full transition-all duration-300`;
            div.innerHTML = `<i class="fas ${icon} text-xl"></i><span class="text-gray-700 text-sm font-medium">${msg}</span>`;
            container.appendChild(div);
            requestAnimationFrame(() => div.classList.remove('translate-x-full'));
            setTimeout(() => { div.classList.add('translate-x-full'); setTimeout(() => div.remove(), 300); }, 4000);
        }

        function togglePass(id, icon) {
            const input = document.getElementById(id);
            if(input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        function switchStep(step) {
            const s1 = document.getElementById('step-1');
            const s2 = document.getElementById('step-2');
            const s3 = document.getElementById('success-state');
            const footer = document.getElementById('footer-link');

            s1.classList.add('hidden');
            s2.classList.add('hidden');
            s3.classList.add('hidden');

            if(step === 2) {
                s2.classList.remove('hidden');
                s2.classList.add('animate-fade-in');
            } else if (step === 3) {
                s3.classList.remove('hidden');
                s3.classList.add('animate-fade-in');
                footer.classList.add('hidden');
            }
        }

        // --- OTP INPUT LOGIC ---
        const otpInputs = document.querySelectorAll('.otp-input');
        otpInputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                if(e.target.value.length > 1) e.target.value = e.target.value.slice(0,1);
                if(e.target.value && index < otpInputs.length -1) otpInputs[index+1].focus();
            });
            input.addEventListener('keydown', (e) => {
                if(e.key === 'Backspace' && !e.target.value && index > 0) otpInputs[index-1].focus();
            });
            input.addEventListener('paste', (e) => {
                e.preventDefault();
                const data = e.clipboardData.getData('text').replace(/\D/g,'').slice(0,6);
                data.split('').forEach((c, i) => otpInputs[i].value = c);
                if(data.length === 6) document.getElementById('new_password').focus();
            });
        });

        // --- REQUEST HANDLER ---
        document.getElementById('requestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('requestBtn');
            const originalContent = btn.innerHTML;
            const email = document.getElementById('email').value;
            
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Memproses...`;

            try {
                // Using explicit BACKEND_URL to avoid "Load Failed"
                const res = await fetch(`${API_BASE_URL}/password/reset/request`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                
                const data = await res.json();

                if (res.status === 202) {
                    // Success Case: User found, OTP Sent
                    retrievedUserId = data.user_id;
                    document.getElementById('display-email').innerText = email;
                    showToast('Kode OTP terkirim!', 'success');
                    switchStep(2);
                } else if (res.status === 200) {
                    // Generic security response
                    showToast('Jika email terdaftar, kode telah dikirim. Cek inbox/spam.', 'success');
                    document.getElementById('email').value = '';
                } else {
                    throw new Error(data.error || 'Gagal memproses permintaan');
                }
            } catch (err) {
                console.error(err);
                showToast(err.message.includes("Failed to fetch") ? "Gagal terhubung ke server (Cek Port)" : err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        });

        // --- RESET HANDLER ---
        document.getElementById('resetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('resetBtn');
            const originalContent = btn.innerHTML;
            const newPass = document.getElementById('new_password').value;
            const confirmPass = document.getElementById('confirm_password').value;
            
            let otpCode = '';
            otpInputs.forEach(i => otpCode += i.value);

            if(otpCode.length !== 6) return showToast('Masukkan 6 digit kode OTP');
            if(newPass !== confirmPass) return showToast('Password konfirmasi tidak cocok');
            if(newPass.length < 8) return showToast('Password minimal 8 karakter');

            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Updating...`;

            try {
                const res = await fetch(`${API_BASE_URL}/password/reset/complete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: retrievedUserId,
                        otp_code: otpCode,
                        new_password: newPass,
                        confirm_password: confirmPass
                    })
                });

                const data = await res.json();

                if(res.ok) {
                    switchStep(3);
                } else {
                    throw new Error(data.error || 'Gagal mereset password');
                }
            } catch (err) {
                showToast(err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        });
    </script>
</body>
</html>